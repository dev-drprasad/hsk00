on: 
  push: 
    branches:
      - main
  pull_request:

name: Test

jobs:
  release:
    name: Create Github Release
    runs-on: ubuntu-latest
    steps:
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1.0.0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        draft: false
        prerelease: false
    - name: Output Release URL File
      run: echo "${{ steps.create_release.outputs.upload_url }}" > release_url.txt
    - name: Save Release URL File for publish
      uses: actions/upload-artifact@v1
      with:
        name: release_url
        path: release_url.txt
  test:
    strategy:
      matrix:
        go-version: [1.15.x]
        os: [ubuntu-20.04, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
    - name: Install Go
      uses: actions/setup-go@v2
      with:
        go-version: ${{ matrix.go-version }}
    - uses: actions/setup-node@v2
      with:
        node-version: '14'
    - name: Install Ubuntu Dependencies
      run: sudo apt clean && sudo apt update && sudo apt install build-essential libgtk-3-dev libwebkit2gtk-4.0-dev
      if: ${{ matrix.os == 'ubuntu-20.04' }}
    - name: Checkout code
      uses: actions/checkout@v2
    - name: Install Project Dep
      run: |
        go mod download
        go get github.com/markbates/pkger/cmd/pkger
    - name: Pkger
      run: pkger -include /assets -o ./cmd
      env:
        GO111MODULE: on
    - name: Build CLI
      run: cd cmd && go build -o ..\hsk00.exe 
      if: ${{ matrix.os != 'windows-latest' }}
    - name: Build Windows CLI
      run: go build -o .\hsk00 .\cmd\*
      if: ${{ matrix.os == 'windows-latest' }}
      continue-on-error: true
    - name: Install Wails
      run: go get -u github.com/wailsapp/wails/cmd/wails
    - name: Setup Account
      run: mkdir -p ~/.wails && echo '{"email":"dev.drprasad@aim.com","name":"REDDY PRASAD"}' > ~/.wails/wails.json
    - name: Build GUI
      run: cd gui && wails build -p
    - name: Make DMG
      run: npx create-dmg ./build/hsk00.app ./build
      continue-on-error: true
      if: ${{ matrix.os == 'macos-latest' }}
    - name: Load Release URL File from release job
      uses: actions/download-artifact@v1
      with:
        name: release_url
    - name: Get Release File Name & Upload URL
      id: get_release_info
      run: |
        echo ::set-output name=file_name::${REPOSITORY_NAME##*/}-${TAG_REF_NAME##*/v} # RepositoryName-v1.0.0
        value=`cat release_url/release_url.txt`
        echo ::set-output name=upload_url::$value
      env:
        TAG_REF_NAME: ${{ github.ref }}
        REPOSITORY_NAME: ${{ github.repository }}
    - name: Upload OSX CLI
      id: upload-osx-cli 
      uses: actions/upload-release-asset@v1
      if: ${{ matrix.os == 'macos-latest' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.get_release_info.outputs.upload_url }}
        asset_path: ./hsk00
        asset_name: hsk00-osx-cli
        asset_content_type: application/octet-stream
    - name: Upload Linux CLI
      id: upload-linux-cli 
      uses: actions/upload-release-asset@v1
      if: ${{ matrix.os == 'ubuntu-20.04' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.get_release_info.outputs.upload_url }}
        asset_path: ./hsk00
        asset_name: hsk00-linux-cli
        asset_content_type: application/octet-stream
    - name: Upload Windows CLI
      id: upload-windows-cli
      continue-on-error: true
      if: ${{ matrix.os == 'windows-latest' }}
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.get_release_info.outputs.upload_url }}
        asset_path: ./hsk00.exe
        asset_name: hsk00-windows-cli.exe
        asset_content_type: application/octet-stream
    - name: Upload OSX GUI
      id: upload-osx-gui
      if: ${{ matrix.os == 'macos-latest' }}
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.get_release_info.outputs.upload_url }}
        asset_path: ./gui/build/hsk00 0.1.0.dmg
        asset_name: hsk00-osx.dmg
        asset_content_type: application/octet-stream
    - name: Upload Linux GUI
      id: upload-linux-gui 
      if: ${{ matrix.os == 'ubuntu-20.04' }}
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.get_release_info.outputs.upload_url }}
        asset_path: ./gui/build/hsk00
        asset_name: hsk00-linux-gui
        asset_content_type: application/octet-stream
    - name: Upload Windows GUI
      id: upload-windows-gui
      if: ${{ matrix.os == 'windows-latest' }}
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.get_release_info.outputs.upload_url }}
        asset_path: ./gui/build/hsk00.exe
        asset_name: hsk00-windows.exe
        asset_content_type: application/octet-stream
    - uses: actions/upload-artifact@v2
      with:
        name: ${{ matrix.os }}
        path: |
          ./hsk00
          ./hsk00.exe
          ./hsk00*.dmg
          ./gui/build/*
